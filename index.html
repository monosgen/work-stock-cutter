<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Work Stock Cutter</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#111111" />

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
body { margin:0; background:#0b0b0c; color:#f3f3f4; }
header { padding:14px; border-bottom:1px solid #222; position:sticky; top:0; background:#0b0b0c; z-index:10; }
h1 { font-size:16px; margin:0 0 10px; }
nav { display:flex; gap:8px; }
button.tab { flex:1; padding:10px; border-radius:12px; border:1px solid #2a2a2a; background:#121214; color:#f3f3f4; }
button.tab.active { border-color:#6a6a6a; background:#17171a; }
main { padding:14px; max-width:900px; margin:0 auto; }
.card { background:#121214; border:1px solid #222; border-radius:16px; padding:14px; margin:12px 0; }
label { font-size:12px; color:#cfcfd6; display:block; margin-bottom:6px; }
input, textarea {
  width:100%; padding:10px 12px; border-radius:12px;
  border:1px solid #2a2a2a; background:#0f0f10; color:#f3f3f4;
}
textarea { min-height:110px; }
.actions { display:flex; gap:10px; flex-wrap:wrap; }
.btn { padding:10px 12px; border-radius:12px; border:1px solid #2a2a2a; background:#17171a; color:#f3f3f4; }
.btn.primary { border-color:#6a6a6a; }
pre { background:#0f0f10; border:1px solid #2a2a2a; padding:12px; border-radius:14px; white-space:pre-wrap; }
.muted { font-size:12px; color:#b8b8c0; }
.pill { display:inline-block; padding:4px 8px; border:1px solid #2a2a2a; border-radius:999px; font-size:12px; }
</style>
</head>

<body>

<header>
  <h1>Work Stock Cutter</h1>
  <nav>
    <button class="tab active" data-screen="calc">Calculate</button>
    <button class="tab" data-screen="stock">Stock</button>
  </nav>
</header>

<main>

<section id="screen-calc">
  <div class="muted" id="ver" style="text-align:center">Version: â€”</div>

  <div class="card">
    <label>Stock Length (mm)</label>
    <input id="stockLen" type="number" value="11900" />

    <label>Profile</label>
    <input id="profile" value="100/4" />

    <label>Lengths (mm)</label>
    <textarea id="lengths" placeholder="6000 3736 4722"></textarea>

    <div class="actions">
      <button class="btn primary" id="btnCalc">Make cut plan</button>
      <button class="btn" id="btnApply" disabled>Apply plan</button>
      <button class="btn" id="btnClear">Clear</button>
    </div>

    <div class="muted">
      Rule: stock first. If a piece doesnâ€™t fit in one bar, it may be welded using max 2 bars.
    </div>
  </div>

  <div class="card">
    <div class="pill">Result</div>
    <pre id="result">â€”</pre>
  </div>
</section>

<section id="screen-stock" style="display:none">
  <div class="card">
    <label>Profile</label>
    <input id="stockProfile" value="100/4" />

    <label>Add length (mm)</label>
    <input id="stockAddLen" />

    <div class="actions">
      <button class="btn primary" id="btnAddBar">Add bar</button>
      <button class="btn" id="btnAddFull">Add full bar</button>
    </div>
  </div>

  <div class="card">
    <div class="pill">Stock</div>
    <pre id="stockView">â€”</pre>
  </div>
</section>

</main>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("./service-worker.js");

const APP_VERSION = "v6.1";
document.getElementById("ver").textContent = "Version: " + APP_VERSION;

const LS = "wsc_stock_v6";

function loadStock(){ return JSON.parse(localStorage.getItem(LS)||"{}"); }
function saveStock(s){ localStorage.setItem(LS,JSON.stringify(s)); }

function addBar(p,l){
  const s=loadStock(); s[p]=s[p]||[]; s[p].push(l); saveStock(s);
}
function stockText(p){
  const s=loadStock()[p]||[];
  return s.length ? s.map(x=>x+" mm").join("\n") : "No stock";
}

function parseLens(t){
  return t.replace(/,/g," ").split(/\s+/).map(Number).filter(x=>x>0);
}

function makePlan(stockLen,profile,cuts){
  const stock=(loadStock()[profile]||[]).sort((a,b)=>b-a);
  const bins=stock.map((l,i)=>({id:"STOCK-"+(i+1),base:l,rem:l,src:"STOCK"}));
  let newId=0;
  const jobs=[];

  function newBin(){
    newId++; const b={id:"NEW-"+newId,base:stockLen,rem:stockLen,src:"NEW"};
    bins.push(b); return b;
  }

  cuts.forEach((L,i)=>{
    let b=bins.find(x=>x.rem>=L);
    if(b){
      b.rem-=L;
      jobs.push(`REQUIRED ${L} mm\n â†’ Use ${b.src} ${b.id} (${b.base})\n`);
      return;
    }
    let b1=bins.find(x=>x.rem>0 && x.rem<L);
    if(b1){
      const need=L-b1.rem;
      let b2=bins.find(x=>x!==b1 && x.rem>=need) || newBin();
      jobs.push(`REQUIRED ${L} mm ðŸ”¥\n â†’ Use ${b1.src} ${b1.id} (${b1.base}) FULL\n â†’ Take ${need} from ${b2.src} ${b2.id}\n`);
      b1.rem=0; b2.rem-=need;
      return;
    }
    const nb=newBin(); nb.rem-=L;
    jobs.push(`REQUIRED ${L} mm\n â†’ Use NEW ${nb.id} (${nb.base})\n`);
  });

  let waste=bins.reduce((s,b)=>s+b.rem,0);
  return {jobs,bins,waste};
}

const tabs=document.querySelectorAll(".tab");
tabs.forEach(t=>t.onclick=()=>{
  tabs.forEach(x=>x.classList.toggle("active",x===t));
  document.getElementById("screen-calc").style.display=t.dataset.screen==="calc"?"":"none";
  document.getElementById("screen-stock").style.display=t.dataset.screen==="stock"?"":"none";
  if(t.dataset.screen==="stock")
    document.getElementById("stockView").textContent=stockText(document.getElementById("stockProfile").value);
});

document.getElementById("btnCalc").onclick=()=>{
  const plan=makePlan(
    +stockLen.value,
    profile.value,
    parseLens(lengths.value)
  );
  document.getElementById("result").textContent=
    "=== WHAT TO USE ===\n\n"+
    plan.jobs.join("\n")+
    "\nTotal leftover saved: "+plan.waste+" mm";
};

document.getElementById("btnAddBar").onclick=()=>{
  addBar(stockProfile.value,+stockAddLen.value);
  stockAddLen.value="";
  stockView.textContent=stockText(stockProfile.value);
};

document.getElementById("btnAddFull").onclick=()=>{
  addBar(stockProfile.value,+stockLen.value);
  stockView.textContent=stockText(stockProfile.value);
};
</script>

</body>
</html>