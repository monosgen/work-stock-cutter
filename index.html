<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Work Stock Cutter</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
body { margin:0; background:#0b0b0c; color:#f3f3f4; }
header { padding:14px; border-bottom:1px solid #222; position:sticky; top:0; background:#0b0b0c; }
h1 { font-size:16px; margin:0 0 8px; font-weight:700; }
nav { display:flex; gap:8px; }
button.tab { flex:1; padding:10px; border-radius:12px; border:1px solid #2a2a2a; background:#121214; color:#f3f3f4; }
button.tab.active { border-color:#6a6a6a; background:#17171a; }
main { padding:14px; max-width:900px; margin:0 auto; }
.card { background:#121214; border:1px solid #222; border-radius:16px; padding:14px; margin:12px 0; }
label { font-size:12px; color:#cfcfd6; display:block; margin:10px 0 6px; }
input, textarea {
  width:100%; padding:10px 12px; border-radius:12px;
  border:1px solid #2a2a2a; background:#0f0f10; color:#f3f3f4;
}
textarea { min-height:110px; resize:vertical; }
.actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.btn { padding:10px 12px; border-radius:12px; border:1px solid #2a2a2a; background:#17171a; color:#f3f3f4; }
.btn.primary { border-color:#6a6a6a; }
.muted { font-size:12px; color:#b8b8c0; }
.pill { display:inline-block; padding:4px 8px; border:1px solid #2a2a2a; border-radius:999px; font-size:12px; }
pre {
  background:#0f0f10; border:1px solid #2a2a2a;
  padding:12px; border-radius:14px;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<header>
  <h1>Work Stock Cutter</h1>
  <nav>
    <button class="tab active" data-tab="calc">Calculate</button>
    <button class="tab" data-tab="stock">Stock</button>
  </nav>
</header>

<main>

<section id="calc">
<div class="muted" style="text-align:center">Version: v6.3</div>

<div class="card">
<label>Stock Length (mm)</label>
<input id="stockLen" type="number" value="11900">

<label>Profile</label>
<input id="profile" value="100/4">

<label>Lengths (mm)</label>
<textarea id="lengths" placeholder="7373 3000"></textarea>

<div class="actions">
<button class="btn primary" id="calcBtn">Make cut plan</button>
<button class="btn" id="clearBtn">Clear</button>
</div>

<div class="muted" style="margin-top:8px">
Rule: stock first. If needed, weld using max 2 bars.
</div>
</div>

<div class="card">
<div class="pill">Result</div>
<pre id="result">â€”</pre>
</div>
</section>

<section id="stock" style="display:none">
<div class="card">
<label>Profile</label>
<input id="stockProfile" value="100/4">

<label>Add stock length (mm)</label>
<input id="stockAdd">

<div class="actions">
<button class="btn primary" id="addStock">Add stock</button>
<button class="btn" id="addFull">Add full bar</button>
<button class="btn" id="clearStock">Clear profile stock</button>
</div>
</div>

<div class="card">
<div class="pill">Stock (this profile)</div>
<pre id="stockView">â€”</pre>
</div>
</section>

</main>

<script>
// PWA
if ("serviceWorker" in navigator) navigator.serviceWorker.register("./service-worker.js");

// Storage
const LS = "wsc_stock_v6_3";

function loadAll(){ try { return JSON.parse(localStorage.getItem(LS)||"{}"); } catch { return {}; } }
function saveAll(v){ localStorage.setItem(LS, JSON.stringify(v)); }

function getStock(p){ return (loadAll()[p] || []).slice(); }
function setStock(p,a){ const s=loadAll(); s[p]=a; saveAll(s); }

function parseLengths(t){
  return t.replace(/,/g," ").split(/\s+/).map(Number).filter(n=>n>0);
}

function refreshStock(){
  const p = stockProfile.value.trim();
  const a = getStock(p).sort((a,b)=>b-a);
  stockView.textContent = a.length ? a.map(x=>x+" mm").join("\n") : "No stock";
}

// Planner
function makePlan(stockLen, profile, needs){
  let bins = getStock(profile).map(l=>({base:l, rem:l}));
  let results = [];
  let totalLeft = 0;

  function newBin(){
    const b={base:stockLen, rem:stockLen};
    bins.push(b); return b;
  }

  for(const need of needs){
    let best = bins.filter(b=>b.rem>=need)
      .sort((a,b)=>(a.rem-need)-(b.rem-need))[0];

    if(best){
      best.rem -= need;
      results.push({need, welded:false, parts:[{cut:need, src:best.base}]});
      continue;
    }

    let donor = bins.find(b=>b.rem>0 && b.rem<need);
    if(donor){
      let take1 = donor.rem;
      donor.rem = 0;
      let rest = need - take1;
      let b2 = bins.find(b=>b.rem>=rest) || newBin();
      b2.rem -= rest;
      results.push({
        need, welded:true,
        parts:[{cut:take1, src:donor.base},{cut:rest, src:b2.base}]
      });
      continue;
    }

    let nb = newBin();
    nb.rem -= need;
    results.push({need, welded:false, parts:[{cut:need, src:stockLen}]});
  }

  totalLeft = bins.reduce((s,b)=>s+b.rem,0);
  return {results, totalLeft};
}

// Output
function format(plan){
  let out=["=== WHAT TO USE ===\n"];
  for(const r of plan.results){
    if(r.welded){
      out.push(`${r.need} ðŸ”¥ = ` + r.parts.map(p=>`${p.cut}(${p.src})`).join(" + "));
    } else {
      out.push(`${r.need} = ${r.parts[0].cut}(${r.parts[0].src})`);
    }
  }
  out.push(`\nLeftover saved: ${plan.totalLeft} mm`);
  return out.join("\n");
}

// UI
const stockLen = document.getElementById("stockLen");
const profile = document.getElementById("profile");
const lengths = document.getElementById("lengths");
const result = document.getElementById("result");

const stockProfile = document.getElementById("stockProfile");
const stockAdd = document.getElementById("stockAdd");
const stockView = document.getElementById("stockView");

document.getElementById("calcBtn").onclick = ()=>{
  const needs = parseLengths(lengths.value);
  if(!needs.length) return;
  const plan = makePlan(+stockLen.value, profile.value.trim(), needs);
  result.textContent = format(plan);
};

document.getElementById("clearBtn").onclick = ()=>{ lengths.value=""; result.textContent="â€”"; };

document.getElementById("addStock").onclick = ()=>{
  const p=stockProfile.value.trim(); const v=+stockAdd.value;
  if(p && v>0){ const a=getStock(p); a.push(v); setStock(p,a); stockAdd.value=""; refreshStock(); }
};

document.getElementById("addFull").onclick = ()=>{
  const p=stockProfile.value.trim();
  const a=getStock(p); a.push(+stockLen.value); setStock(p,a); refreshStock();
};

document.getElementById("clearStock").onclick = ()=>{
  setStock(stockProfile.value.trim(),[]); refreshStock();
};

document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.getElementById("calc").style.display=b.dataset.tab==="calc"?"":"none";
    document.getElementById("stock").style.display=b.dataset.tab==="stock"?"":"none";
    refreshStock();
  };
});

refreshStock();
</script>

</body>
</html>
